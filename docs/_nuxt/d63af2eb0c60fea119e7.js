(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{441:function(e,t,o){var content=o(478);"string"==typeof content&&(content=[[e.i,content,""]]),content.locals&&(e.exports=content.locals);(0,o(49).default)("5e292ede",content,!0,{sourceMap:!1})},477:function(e,t,o){"use strict";var r=o(441);o.n(r).a},478:function(e,t,o){(t=o(48)(!1)).push([e.i,"#video-box[data-v-361387cc]{padding:50px}",""]),e.exports=t},529:function(e,t,o){"use strict";o.r(t);o(95),o(34),o(28),o(19),o(66),o(51);var r=o(35),n=o(96);function c(object,e){var t=Object.keys(object);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(object);e&&(o=o.filter((function(e){return Object.getOwnPropertyDescriptor(object,e).enumerable}))),t.push.apply(t,o)}return t}var d={name:"videoPage",data:function(){return{isCaller:!1,otherUserId:"",otherNickname:"",otherAvatar:"",localVideo:"",remoteVideo:"",audioInputSelect:"",audioOutputSelect:"",videoSelect:"",selectors:"",localStream:"",localVideoSender:"",localAudioSender:"",remoteStream:"",deviceLength:0,peerConnection:{},peerConnectionConfig:{iceServers:[{urls:"stun:stun.stunprotocol.org:3478"},{urls:"stun:stun.l.google.com:19302"},{urls:"turn:192.168.1.11",username:"ninefingers",credential:"youhavetoberealistic"}]},stompClient:{},privateClient:{}}},props:[],computed:function(e){for(var i=1;i<arguments.length;i++){var source=null!=arguments[i]?arguments[i]:{};i%2?c(Object(source),!0).forEach((function(t){Object(r.a)(e,t,source[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(source)):c(Object(source)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(source,t))}))}return e}({},Object(n.b)(["isLogin","userId","openId","nickname","avatar","userType","signalMessage","_connection"])),watch:{signalMessage:function(e,t){console.log("signalMessage变化---------"),this.gotMessageFromServer(e)}},methods:{pageReady:function(){var e=this;this.localVideo=document.getElementById("localVideo"),this.remoteVideo=document.getElementById("remoteVideo"),this.audioInputSelect=document.querySelector("select#audioSource"),this.audioOutputSelect=document.querySelector("select#audioOutput"),this.videoSelect=document.querySelector("select#videoSource"),this.selectors=[this.audioInputSelect,this.audioOutputSelect,this.videoSelect],this.audioOutputSelect.disabled=!("sinkId"in HTMLMediaElement.prototype),setInterval((function(){navigator.mediaDevices.enumerateDevices().then(e.gotDevices).catch(e.handleError)}),2e3),this.audioInputSelect.onchange=this.start(),this.audioOutputSelect.onchange=this.attachSinkId(this.remoteVideo,this.audioOutputSelect.value),this.videoSelect.onchange=this.start(),this.start()},start:function(){var e=this.audioInputSelect.value,t=this.videoSelect.value,o={audio:{deviceId:e?{exact:e}:void 0},video:{deviceId:t?{exact:t}:void 0}};navigator.mediaDevices.getUserMedia(o).then(this.gotLocalMedia).then(this.gotDevices).catch(this.handleError)},gotLocalMedia:function(e){var t=this;if(this.localStream=e,this.localVideo.srcObject=e,this.localStream)return console.log("changed localStreamTracks1"),console.log("changed localStreamTracks:",this.localStream.getTracks()),this.localStream.getTracks().forEach((function(track){"video"==track.kind&&(t.localVideoSender?t.localVideoSender.replaceTrack(track):t.localVideoSender=t.peerConnection.addTrack(track)),"audio"==track.kind&&(t.localAudioSender?t.localAudioSender.replaceTrack(track):t.localAudioSender=t.peerConnection.addTrack(track))})),navigator.mediaDevices.enumerateDevices()},gotDevices:function(e){if(this.deviceLength!==e.length){this.deviceLength=e.length;var t=this.selectors.map((function(select){return select.value}));this.selectors.forEach((function(select){for(;select.firstChild;)select.removeChild(select.firstChild)}));for(var i=0;i!==e.length;++i){var o=e[i],option=document.createElement("option");option.value=o.deviceId,"audioinput"===o.kind?(option.text=o.label||"microphone ".concat(audioInputSelect.length+1),this.audioInputSelect.appendChild(option)):"audiooutput"===o.kind?(option.text=o.label||"speaker ".concat(audioOutputSelect.length+1),this.audioOutputSelect.appendChild(option)):"videoinput"===o.kind?(option.text=o.label||"camera ".concat(videoSelect.length+1),this.videoSelect.appendChild(option)):console.log("Some other kind of source/device: ",o)}this.selectors.forEach((function(select,e){Array.prototype.slice.call(select.childNodes).some((function(o){return o.value===t[e]}))&&(select.value=t[e])}))}},attachSinkId:function(element,e){void 0!==element.sinkId?element.setSinkId(e).then((function(){console.log("Success, audio output device attached: ${sinkId}")})).catch((function(e){var t=e;"SecurityError"===e.name&&(t="You need to use HTTPS for selecting audio output device: ${error}"),console.error(t),audioOutputSelect.selectedIndex=0})):console.warn("Browser does not support output device selection.")},initWebRTC:function(){this.peerConnection=new RTCPeerConnection(this.peerConnectionConfig),this.peerConnection.onicecandidate=this.gotIceCandidate,this.peerConnection.ontrack=this.gotRemoteStream,console.log("localStreamTracks:",this.localStream)},createdDescription:function(e){var t=this;console.log("got description"),this.peerConnection.setLocalDescription(e).then((function(){var data={senderId:t.userId,senderAvatar:t.avatar,senderNickname:t.nickname,senderType:t.userType,isPrivate:!0,privateType:4,sdp:t.peerConnection.localDescription,atUserId:t.otherUserId,atUserNickname:t.otherNickname,atUserAvatar:t.otherAvatar};t.$store.commit("sendMessage",{url:"/app/chat",data:data})})).catch(this.handleError)},gotIceCandidate:function(e){if(null!=e.candidate){var data={senderId:this.userId,senderAvatar:this.avatar,senderNickname:this.nickname,senderType:this.userType,isPrivate:!0,privateType:5,ice:e.candidate,atUserId:this.otherUserId,atUserNickname:this.otherNickname,atUserAvatar:this.otherAvatar};this.$store.commit("sendMessage",{url:"/app/chat",data:data})}console.log("this.peerConnection.onicecandidate")},gotMessageFromServer:function(e){var t=this;console.log("处理接受到的信令",e),e.sdp?this.peerConnection.setRemoteDescription(new RTCSessionDescription(e.sdp)).then((function(){console.log("处理接受到的信令1"),"offer"==e.sdp.type&&(console.log("处理接受到的信令2"),t.peerConnection.createAnswer().then(t.createdDescription).catch(t.handleError))})).catch(this.handleError):e.ice&&this.peerConnection.addIceCandidate(new RTCIceCandidate(e.ice)).catch(this.handleError)},gotRemoteStream:function(e){var t=this;console.log("got remote stream"),console.log("remote stream:",e.streams[0]),console.log("remote track:",e.track),this.remoteStream||(this.remoteStream=new MediaStream,this.remoteVideo.srcObject=this.remoteStream,this.remoteVideo.play()),console.log(this.remoteStream),"video"==e.track.kind&&(this.remoteStream.getVideoTracks().forEach((function(track){return t.remoteStream.removeTrack(track)})),this.remoteStream.addTrack(e.track)),"audio"==e.track.kind&&(this.remoteStream.getAudioTracks().forEach((function(track){return t.remoteStream.removeTrack(track)})),this.remoteStream.addTrack(e.track)),console.log("video tracks:",this.remoteStream.getVideoTracks()),console.log("audio tracks:",this.remoteStream.getAudioTracks())},handleError:function(e){console.log("err:",e)},videoCall:function(){if(this.isCaller){var data={senderId:this.userId,senderAvatar:this.avatar,senderNickname:this.nickname,richMessage:"videoCalling",senderType:this.userType,imageUrl:"",isPrivate:!0,privateType:1,atUserId:this.otherUserId,atUserNickname:this.otherNickname,atUserAvatar:this.otherAvatar};this.$store.commit("sendMessage",{url:"/app/chat",data:data})}else this.peerConnection.createOffer().then(this.createdDescription).catch(this.handleError)}},components:{},beforeCreate:function(){},created:function(){},beforeMount:function(){if(localStorage.videoUser){var e=JSON.parse(localStorage.videoUser);this.isCaller=e.isCaller,this.otherUserId=e.id,this.otherNickname=e.nickname,this.otherAvatar=e.avatar,console.log("对方信息：",e),console.log("this.otherUserId--------1:",e.id)}else console.log("err:没有对方信息");this.$store.commit("setIsVideoPage",!0),this.$store.dispatch("getLocalData"),this.initWebRTC(),this.$store.dispatch("initWebSocket")},mounted:function(){var e=this;this.$nextTick((function(){e.pageReady(),console.log("this.otherUserId--------2:",e.otherUserId),e._connection.then(e.videoCall).catch(e.handleError)}))},beforeUpdate:function(){},updated:function(){},activated:function(){},deactivated:function(){},beforeDestroy:function(){},destroyed:function(){},errorCaptured:function(){}},l=(o(477),o(38)),component=Object(l.a)(d,(function(){var e=this,t=e.$createElement,o=e._self._c||t;return o("div",{attrs:{id:"video-box"}},[o("video",{staticStyle:{width:"40%"},attrs:{id:"localVideo",autoplay:"",muted:"",controls:"controls"},domProps:{muted:!0}}),e._v(" "),o("video",{staticStyle:{width:"40%"},attrs:{id:"remoteVideo",autoplay:"",controls:"controls"}}),e._v(" "),e._m(0),e._v(" "),e._m(1),e._v(" "),e._m(2),e._v(" "),o("br")])}),[function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"select"},[t("label",{attrs:{for:"audioSource"}},[this._v("Audio input device:")]),this._v(" "),t("select",{attrs:{id:"audioSource"}})])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"select"},[t("label",{attrs:{for:"audioOutput"}},[this._v("Audio output device:")]),this._v(" "),t("select",{attrs:{id:"audioOutput"}})])},function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"select"},[t("label",{attrs:{for:"videoSource"}},[this._v("Camera device:")]),this._v(" "),t("select",{attrs:{id:"videoSource"}})])}],!1,null,"361387cc",null);t.default=component.exports}}]);